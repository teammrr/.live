<script>import { getContext, onMount } from "svelte";
import TreeViewDataDrivenItem from "./TreeViewDataDrivenItem.svelte";
import TreeViewItem from "./TreeViewItem.svelte";
export let nodes = [];
export let selection = getContext("selection");
export let multiple = getContext("multiple");
let group;
let name = "";
onMount(() => {
  name = String(Math.random());
  if (selection) {
    group = multiple ? [] : "";
    if (multiple) {
      nodes.forEach((node) => {
        if (!Array.isArray(group))
          return;
        if (node.children && node.children.length > 0) {
          if (node.children.some((c) => c.indeterminate)) {
            node.indeterminate = true;
          } else if (node.children.every((c) => c.checked)) {
            node.indeterminate = false;
            group.push(node.value);
            group = group;
          } else if (node.children.some((c) => c.checked)) {
            node.indeterminate = true;
          } else {
            node.indeterminate = false;
            node.checked = false;
          }
        } else if (node.checked) {
          group.push(node.value);
          group = group;
        }
      });
    } else {
      nodes.forEach((node) => {
        if (!node.checked)
          return;
        group = node.value;
      });
    }
  }
});
function onGroupChange() {
  if (multiple) {
    nodes.forEach((node) => {
      if (!Array.isArray(group))
        return;
      node.checked = group.includes(node.value);
    });
  } else {
    nodes.forEach((node) => {
      node.checked = node.value === group;
    });
  }
}
export let treeItems = [];
let children = [];
</script>

{#if nodes && nodes.length > 0}
	{#each nodes as node, i}
		<TreeViewItem
			bind:this={treeItems[i]}
			bind:open={node.open}
			hideLead={!node.lead}
			hideChildren={!node.children || node.children.length === 0}
			bind:disabled={node.disabled}
			bind:group
			bind:name
			bind:indeterminate={node.indeterminate}
			bind:value={node.value}
			bind:children={children[i]}
			on:change={onGroupChange}
			on:change
			on:click
			on:toggle
			on:keydown
			on:keyup
		>
			{@html node.content}
			<svelte:fragment slot="lead">
				{@html node.lead}
			</svelte:fragment>
			<svelte:fragment slot="children">
				<TreeViewDataDrivenItem bind:nodes={node.children} bind:treeItems={children[i]} />
			</svelte:fragment>
		</TreeViewItem>
	{/each}
{/if}
